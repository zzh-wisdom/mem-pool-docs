# 一致性哈希简介

## 样例背景

为了应对大规模并发访问场景，系统会将数据分散到不同的节点上进行处理，如下图所示。

![](images/Markdown-image-2021-05-12-10-18-37.png)

集群中有n个节点，假如使用常见的哈希后取余的方法将对象分散到不同的节点。那么，当一个节点加入或者退出集群的时候，大部分对象的映射位置都会发生变化，导致整个集群的数据移动。

一致性哈希就用于解决上述的问题，最早由David Karger 等6个人发布学术论文《[Consistent hashing and random trees: distributed caching protocols for relieving hot spots on the World Wide Web](https://dl.acm.org/citation.cfm?id=258660)（一致性哈希和随机树：用于缓解万维网上热点的分布式缓存协议）》

## 一致性哈希概念

**一致哈希**是一种特殊的哈希算法。在使用一致哈希算法后，哈希表槽位数（大小）的改变平均只需要对 K/n 个关键字重新映射，其中 K 是关键字的数量，n 是槽位数量。

## 一致性哈希的特性

论文中提到良好的一致性哈希应该满足以下几个特性。

1. 平衡性(Balance)

平衡性是指哈希的结果能尽可能地将数据平均分布到所有的节点上。很多哈希算法都能够满足这一条件。

2. 单调性(Monotonicity)

单调性是指如果已经有一些数据通过哈希分布到集群中，然后又有新的节点加入到集群，那么当存在一些对象需要调整映射位置时，它们只能映射到新加入的节点，而不会被映射到原有的节点中。

3. 分散性(Spread)
4. 负载(Load)

这两个是分布式cache场景中的特性。

5. 平滑性(Smoothness)

平滑性是指节点的数目平滑改变和对象位置的平滑改变是一致的。

> 当集群中的节点数量平滑改变时，对象数据的迁移也是平滑的，而不会造成大规模的数据迁移。

## 一致性哈希的原理

一致性哈希将整个哈希值空间组织成一个虚拟的圆环，这里假设某个哈希函数H的值空间为0-2<sup>32</sup>-1。整个哈希空间按照顺时针方向从小到大组织。

![](images/Markdown-image-2021-05-12-14-43-33.png)

然后，将集群中的每个节点进行哈希，具体可以选择服务器ip或者主机名作为关键字进行哈希，这样就可以确定每个服务器节点在哈希环上的位置。这里假设有四个节点，如下图所示。

![](images/Markdown-image-2021-05-12-14-55-23.png)

接下来，使用如下算法定位数据所在的节点：将数据key使用相同的函数Hash计算哈希值，该哈希值对应到环上的一个位置，从该位置沿环顺时针“遍历”，第一个遇到的节点就是该数据所在的位置。下图展示了四个对象所在节点的计算过程。

![](images/Markdown-image-2021-05-12-15-10-14.png)

根据上述的算法，对象0会被定位到节点B。

下面分析节点退出和加入的情况。假设Node C宕机了，按照前面所说的数据定位过程，只有对象1受影响，它被重新定位到定位到Node D。一般地，如果一个节点退出系统，那么只有该节点到环空间的上一个节点（沿逆时针找到的第一个节点）之间的数据需要重新定位，其他数据不受影响。

如果在集群中增加一个Node X，如下图所示。

![](images/Markdown-image-2021-05-12-15-26-45.png)

此时也只有对象1需要重新定位到Node X，其他节点不受影响。

综上，当节点的加入或删除时，系统都只用重新定位一小部分数据。

### 节点数较少时的数据均衡

另外，一致性哈希算法在节点太少时，容易因为节点分部不均匀而造成数据倾斜的问题。例如系统中只有两个节点，它们在换上的分布如下。

![](images/Markdown-image-2021-05-12-15-33-43.png)

此时会导致大量的数据定位在Node A，而只有少量数据定位在Node B的数据倾斜问题。

一致性哈希算法引入了虚拟节点的机制，即对于每个节点计算多个哈希值，每个计算结果上都放置一个该节点，称为虚拟节点。具体的做法可以在节点ip或者主机名后增加编号来实现。例如上面的情况，可以为每台服务器计算三个虚拟节点，于是可以分别计算 “Node A#1”、“Node A#2”、“Node A#3”和“Node B#1”、“Node B#2”、“Node B#3”的哈希值，于是形成六个虚拟节点。

![](images/Markdown-image-2021-05-12-15-45-32.png)

然后，使用同样的数据定位方法，只是多一步从虚拟节点到实际节点的映射，例如定位到“Node A#1”、“Node A#2”、“Node A#3”三个虚拟节点的数据均定位到Node A上。这样就解决了服务节点太少时数据倾斜的问题。

## 参考

1. [维基百科-一致性哈希](https://zh.wikipedia.org/wiki/%E4%B8%80%E8%87%B4%E5%93%88%E5%B8%8C#cite_note-KargerEtAl1997-1)
2. 一致性Hash算法背景：https://www.cnblogs.com/williamjie/p/9477852.html （介绍了一个环形映射的例子）
3. 