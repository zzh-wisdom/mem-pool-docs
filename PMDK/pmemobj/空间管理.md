# pmemobj 空间管理概况

一个pool的空间：

- pool头部，一个，2KB
- lane_layout。包含多个，用于存储log
- heap_layout。一个，用于存储数据

struct heap_layout：

- heap_header（堆头部），一个，1KB
- zone，多个

一个zone包含：

- zone_header，一个，64B
- chunk_headers[MAX_CHUNK]，chunk头部数组（数组大小为65535-7），8*(65535-7)B
- chunk，>= 1个，具体的个数由zone大小决定，每个chunk 256KB

chunk空间由chunk_run进行管理，一个chunk_run包含：

- 第一个chunk
  - struct chunk_run_header，头部，16B
  - Bitmap，40*8B=320B
  - 用户数据，256KB-16B-320B
- (n-1)个chunk

其中n的取值为1-10。chunk_run最多可以管理10个chunk，这些chunk使用一个bitmap进行管理。

## Pool概念

创建池时，实际上会创建一个`pool_set`，它包含同一个pool的多个副本`struct pool_replica` *replica[]。然后每一个副本包含多个`部分`（part），一个`部分`（part）可以简单理解为一个文件，也就是说**一个pool可以包含多个文件**。这部分的详细逻辑还没有看。

一般我们可以调用如下函数创建一个pool。

```c
pmemobj_create(PATH, LAYOUT_NAME, POOL_SIZE, MODE);
```

这样，就会创建一个只有一个副本的pool_set，而且这个副本只有一个部分（part），这个部分实际上会存储文件PATH的描述符，用于读写。


